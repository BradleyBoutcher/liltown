pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

-- lil' town -- by bradley boutcher

local guy = {
	x = 500,
	y = 75,
	sprt = 1,
	prev = 2,
	f = false,
	free = true,
	o = 0
}

-- clock 
local hour,minute,second = 0,0,0
-- day or night
am = true
-- frame timer
local frame = 0
-- previous button input
local p_btn = 0
-- camera coords for top left corner
local cam_x 
local cam_y 
-- item location info
local plants = {} 

function generatemap()
	for x=0,127,1 do
		for y=0,31,1 do
			if (rnd(100) > 75) then
				add(plants, {x=x,y=y})
				mset(x,y,18)
			end
		end
	end
end

-- determine state changes for player sprite
function anim_guy()
	if (frame % 10 == 0 or p_btn != btn()) then
		if(btn(4)) then 
			guy.sprt = 4
		elseif(guy.sprt == 4) then
			guy.sprt = 5
			take_item()
		elseif(btn() == 0) then
			if (guy.sprt == 1) guy.sprt = 3 else guy.sprt = 1
		else 
			if (guy.sprt == 1) then
				if (guy.prev == 2) then
					guy.sprt, guy.prev = 0, 0
					sfx(1)
				elseif (guy.prev == 0) then
					guy.sprt, guy.prev = 2, 2
					sfx(2)
				end
			else 
				guy.sprt = 1
			end
		end
	end
end

-- if within boundaries, move player along x / y / z 
-- if player is in center of screen, move camera
function move_guy()
		if (btn(0) and guy.x > 0) then
			guy.x -= 1
			guy.f = true
			if (cam_x > 0 and guy.x <= 959) cam_x -= 1
		end
		if (btn(1) and guy.x < 1017) then 
			guy.x += 1
			guy.f = false
			if (cam_x < 895 and guy.x >=64) cam_x += 1
		end
		if (btn(2) and guy.y > 0) then 
			guy.y -= 1
			if (cam_y > 0 and guy.y <= 191) cam_y -= 1
		end
		if (btn(3) and guy.y < 255) then
			guy.y += 1
			if (cam_y < 127 and guy.y >= 64) cam_y += 1
		end
end

-- find object collided with
function take_item()
	cx = (guy.x + 4) / 8 -- add 4 to use the center of the guy
	cy = (guy.y + 4) / 8
	i = mget(cx, cy)
	if  i == 18 then
		mset(cx, cy, 0)
		del(plants,{cx,cy})
		sfx(0)
	end
	guy.o = i
end

-- spawn new plants near current plants
function grow_plants()
	if (second % 10 == 0) then
		local x = rnd(127)
		local y = rnd(31)
		if (mget(x,y) == 18) then
			for j=x-1,x+1 do
				for k=y-1,y+1 do
					if(mget(j,k) == 0 and rnd(100) > 65) then
						mset(j,k,18)
						add(plants,{x=j,y=k})
					end	
				end
			end
		end
	end
end

-- Animated clock in top right hand corner
function draw_clock() 
	x = cam_x+115
	y = cam_y + 12
	circfill(x,y,10,13)
	circ(x,y,10,9)
	-- minute hand
	minute_x = x + (-sin(minute/60)*8)
	minute_y = y + (-cos(minute/60)*8)
	line(x,y,minute_x, minute_y,9)
	-- hour hand
	hourX = x + (-sin(hour/60)*5)
	hourY = y + (-cos(hour/60)*5)
	line(x,y,hourX,hourY,6)
end

-- increment frame timer and clock values
function time()
	if (frame > 29) then
		frame = 0
		if (second > 59) then
			second = 0
			if (minute > 59) then
				minute = 0
				if (hour > 11) then
					if (am) am = false else am = true
					hour = 0
				else 
					hour += 1
				end
			else
				minute +=1
			end
		else 
			second += 20
		end
	else 
		frame += 1
	end
end

function _init()
	generatemap()
	cam_x = guy.x - 64
	cam_y = guy.y - 64
end

function _update()
	time()
	grow_plants()
	anim_guy()
	move_guy()
	-- record btn press on current frame
	p_btn = btn()
end

function _draw()
	cls()
	spr(guy.sprt,guy.x,guy.y,1,1,guy.f)
	camera(cam_x,cam_y)
	map(0, 0, 0, 0, 128, 32)
	draw_clock()
	print("h:" ..hour.. "m:" ..minute.. "s:" ..second,cam_x, cam_y, 10)
end

__gfx__
00fff00000fff00000fff00000000000000000000f0000f000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f0f0f000f0f0f000f0f0f0000fff0000000000000fff00000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ffff0000ffff0000ffff000f0f0f00000000000f0f0f0000000000000000000000000000000000000000000000000000000000000000000000000000000000
000f0000000f0000000f000000ffff0000fff00000ffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00444f000044400000444000000f00000f0f0f000044400000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f44400000f44f00004f40000044400004ffff000044400000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111000001110000011100000f44f00044440000111110000000000000000000000000000000000000000000000000000000000000000000000000000000000
01000100001010000100010000111000001f1f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000008288880000000000000000000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000028288888000000b000000b000300000000044400000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0008282888888000000b00b000300000004444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000
0028288888888800000b0bb000000bb0004fffffffff544000000000000000000000000000000000000000000000000000000000000000000000000000000000
08282882288888800b0b03000000bb00004f000f00ff554000000000000000000000000000000000000000000000000000000000000000000000000000000000
08288844428888800030300000033000004fffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000
08288444442888800003300000000000004f5f000f000f4000000000000000000000000000000000000000000000000000000000000000000000000000000000
08884444444288800000000000000000004fffffffffff4000000000000000000000000000000000000000000000000000000000000000000000000000000000
08844444444428800000004000000000004444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000
00444444444444000b00044400000600000000044400030000000000000000000000000000000000000000000000000000000000000000000000000000000000
0046d644444444003040444400500000000000044000003000000000000000000000000000000000000000000000000000000000000000000000000000000000
004ddd4488884400000444f005605600000330044400000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0046d6448888440004444f0000005550030300004300300000000000000000000000000000000000000000000000000000000000000000000000000000000000
00422244828844004f4440000005566000b00304443300b000000000000000000000000000000000000000000000000000000000000000000000000000000000
0044444488884400fff4000000556666000030b44b000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00444444888844004f40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0202020202020000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000500000555008550095500b55000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00100000140200e000000001a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000001b01000000130000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
00 01424344
00 4e424344

